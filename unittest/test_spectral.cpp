// Copyright Contributors to the rawtoaces project.
// SPDX-License-Identifier: Apache-2.0
// https://github.com/AcademySoftwareFoundation/rawtoaces

#include <OpenImageIO/unittest.h>

#include <rawtoaces/spectral_solver.hpp>
#include <rawtoaces/spectral_data.hpp>
#include <rawtoaces/define.h>

using namespace std;
using namespace rta;

const std::string data_path = "../../data/";

// clang-format off

const double nikon_d200_sensitivity[81][3] = {
    { 0.0243, 0.0296, 0.0477 }, { 0.0160, 0.0201, 0.0336 },
    { 0.0078, 0.0106, 0.0195 }, { 0.0062, 0.0086, 0.0152 },
    { 0.0045, 0.0065, 0.0108 }, { 0.0043, 0.0059, 0.0086 },
    { 0.0040, 0.0052, 0.0064 }, { 0.0056, 0.0073, 0.0536 },
    { 0.0073, 0.0095, 0.1008 }, { 0.0175, 0.0234, 0.2714 },
    { 0.0277, 0.0373, 0.4419 }, { 0.0304, 0.0572, 0.6097 },
    { 0.0332, 0.0771, 0.7776 }, { 0.0300, 0.0906, 0.8411 },
    { 0.0268, 0.1040, 0.9046 }, { 0.0255, 0.1311, 0.9340 },
    { 0.0243, 0.1583, 0.9634 }, { 0.0257, 0.2160, 0.9511 },
    { 0.0270, 0.2737, 0.9389 }, { 0.0277, 0.3003, 0.8601 },
    { 0.0285, 0.3269, 0.7812 }, { 0.0280, 0.3384, 0.7242 },
    { 0.0275, 0.3498, 0.6672 }, { 0.0287, 0.4458, 0.5531 },
    { 0.0298, 0.5417, 0.4391 }, { 0.0343, 0.6403, 0.3571 },
    { 0.0388, 0.7388, 0.2751 }, { 0.0523, 0.8374, 0.1973 },
    { 0.0659, 0.9359, 0.1195 }, { 0.0715, 0.9680, 0.0807 },
    { 0.0771, 1.0000, 0.0419 }, { 0.0589, 0.9779, 0.0306 },
    { 0.0406, 0.9559, 0.0194 }, { 0.0301, 0.9072, 0.0137 },
    { 0.0196, 0.8584, 0.0081 }, { 0.0196, 0.7891, 0.0058 },
    { 0.0197, 0.7198, 0.0035 }, { 0.0427, 0.6480, 0.0027 },
    { 0.0658, 0.5762, 0.0020 }, { 0.2576, 0.5059, 0.0021 },
    { 0.4494, 0.4355, 0.0022 }, { 0.5820, 0.3596, 0.0026 },
    { 0.7146, 0.2836, 0.0030 }, { 0.7150, 0.2226, 0.0028 },
    { 0.7155, 0.1617, 0.0026 }, { 0.6795, 0.1179, 0.0025 },
    { 0.6436, 0.0741, 0.0023 }, { 0.6070, 0.0583, 0.0021 },
    { 0.5703, 0.0426, 0.0019 }, { 0.5215, 0.0340, 0.0027 },
    { 0.4727, 0.0254, 0.0036 }, { 0.4253, 0.0218, 0.0033 },
    { 0.3779, 0.0182, 0.0031 }, { 0.3227, 0.0148, 0.0034 },
    { 0.2674, 0.0113, 0.0037 }, { 0.2406, 0.0105, 0.0033 },
    { 0.2137, 0.0097, 0.0029 }, { 0.1695, 0.0087, 0.0029 },
    { 0.1253, 0.0078, 0.0028 }, { 0.0929, 0.0065, 0.0023 },
    { 0.0604, 0.0053, 0.0019 }, { 0.0368, 0.0042, 0.0022 },
    { 0.0131, 0.0032, 0.0024 }, { 0.0088, 0.0029, 0.0031 },
    { 0.0044, 0.0026, 0.0038 }, { 0.0040, 0.0024, 0.0033 },
    { 0.0037, 0.0022, 0.0027 }, { 0.0035, 0.0023, 0.0033 },
    { 0.0033, 0.0023, 0.0039 }, { 0.0028, 0.0020, 0.0034 },
    { 0.0023, 0.0017, 0.0029 }, { 0.0018, 0.0014, 0.0024 },
    { 0.0014, 0.0011, 0.0019 }, { 0.0009, 0.0008, 0.0014 },
    { 0.0004, 0.0005, 0.0009 }, { 0.0005, 0.0006, 0.0009 },
    { 0.0005, 0.0006, 0.0010 }, { 0.0006, 0.0007, 0.0010 },
    { 0.0007, 0.0008, 0.0011 }, { 0.0007, 0.0008, 0.0011 },
    { 0.0008, 0.0009, 0.0012 }
};

const double illuminant_ISO7589_SPD[81] = {
    0.0400, 0.0500, 0.0600, 0.0700, 0.0800, 0.0900, 0.1000, 0.1100,
    0.1200, 0.1325, 0.1450, 0.1575, 0.1700, 0.1800, 0.1900, 0.2025,
    0.2150, 0.2275, 0.2400, 0.2525, 0.2650, 0.2800, 0.2950, 0.3075,
    0.3200, 0.3350, 0.3500, 0.3650, 0.3800, 0.3925, 0.4050, 0.4225,
    0.4400, 0.4550, 0.4700, 0.4850, 0.5000, 0.5125, 0.5250, 0.5400,
    0.5550, 0.5675, 0.5800, 0.5950, 0.6100, 0.6225, 0.6350, 0.6475,
    0.6600, 0.6750, 0.6900, 0.7025, 0.7150, 0.7275, 0.7400, 0.7525,
    0.7650, 0.7750, 0.7850, 0.7975, 0.8100, 0.8225, 0.8350, 0.8475,
    0.8600, 0.8700, 0.8800, 0.8900, 0.9000, 0.9100, 0.9200, 0.9275,
    0.9350, 0.9450, 0.9550, 0.9650, 0.9750, 0.9800, 0.9850, 0.9925,
    1.0000
};

const double colour_matching_XYZ[81][3] = {
    { 0.001368000, 0.000039000, 0.006450001 },
    { 0.002236000, 0.000064000, 0.010549990 },
    { 0.004243000, 0.000120000, 0.020050010 },
    { 0.007650000, 0.000217000, 0.036210000 },
    { 0.014310000, 0.000396000, 0.067850010 },
    { 0.023190000, 0.000640000, 0.110200000 },
    { 0.043510000, 0.001210000, 0.207400000 },
    { 0.077630000, 0.002180000, 0.371300000 },
    { 0.134380000, 0.004000000, 0.645600000 },
    { 0.214770000, 0.007300000, 1.039050100 },
    { 0.283900000, 0.011600000, 1.385600000 },
    { 0.328500000, 0.016840000, 1.622960000 },
    { 0.348280000, 0.023000000, 1.747060000 },
    { 0.348060000, 0.029800000, 1.782600000 },
    { 0.336200000, 0.038000000, 1.772110000 },
    { 0.318700000, 0.048000000, 1.744100000 },
    { 0.290800000, 0.060000000, 1.669200000 },
    { 0.251100000, 0.073900000, 1.528100000 },
    { 0.195360000, 0.090980000, 1.287640000 },
    { 0.142100000, 0.112600000, 1.041900000 },
    { 0.095640000, 0.139020000, 0.812950100 },
    { 0.057950010, 0.169300000, 0.616200000 },
    { 0.032010000, 0.208020000, 0.465180000 },
    { 0.014700000, 0.258600000, 0.353300000 },
    { 0.004900000, 0.323000000, 0.272000000 },
    { 0.002400000, 0.407300000, 0.212300000 },
    { 0.009300000, 0.503000000, 0.158200000 },
    { 0.029100000, 0.608200000, 0.111700000 },
    { 0.063270000, 0.710000000, 0.078249990 },
    { 0.109600000, 0.793200000, 0.057250010 },
    { 0.165500000, 0.862000000, 0.042160000 },
    { 0.225749900, 0.914850100, 0.029840000 },
    { 0.290400000, 0.954000000, 0.020300000 },
    { 0.359700000, 0.980300000, 0.013400000 },
    { 0.433449900, 0.994950100, 0.008749999 },
    { 0.512050100, 1.000000000, 0.005749999 },
    { 0.594500000, 0.995000000, 0.003900000 },
    { 0.678400000, 0.978600000, 0.002749999 },
    { 0.762100000, 0.952000000, 0.002100000 },
    { 0.842500000, 0.915400000, 0.001800000 },
    { 0.916300000, 0.870000000, 0.001650001 },
    { 0.978600000, 0.816300000, 0.001400000 },
    { 1.026300000, 0.757000000, 0.001100000 },
    { 1.056700000, 0.694900000, 0.001000000 },
    { 1.062200000, 0.631000000, 0.000800000 },
    { 1.045600000, 0.566800000, 0.000600000 },
    { 1.002600000, 0.503000000, 0.000340000 },
    { 0.938400000, 0.441200000, 0.000240000 },
    { 0.854449900, 0.381000000, 0.000190000 },
    { 0.751400000, 0.321000000, 0.000100000 },
    { 0.642400000, 0.265000000, 0.000050000 },
    { 0.541900000, 0.217000000, 0.000030000 },
    { 0.447900000, 0.175000000, 0.000020000 },
    { 0.360800000, 0.138200000, 0.000010000 },
    { 0.283500000, 0.107000000, 0.000000000 },
    { 0.218700000, 0.081600000, 0.000000000 },
    { 0.164900000, 0.061000000, 0.000000000 },
    { 0.121200000, 0.044580000, 0.000000000 },
    { 0.087400000, 0.032000000, 0.000000000 },
    { 0.063600000, 0.023200000, 0.000000000 },
    { 0.046770000, 0.017000000, 0.000000000 },
    { 0.032900000, 0.011920000, 0.000000000 },
    { 0.022700000, 0.008210000, 0.000000000 },
    { 0.015840000, 0.005723000, 0.000000000 },
    { 0.011359160, 0.004102000, 0.000000000 },
    { 0.008110916, 0.002929000, 0.000000000 },
    { 0.005790346, 0.002091000, 0.000000000 },
    { 0.004109457, 0.001484000, 0.000000000 },
    { 0.002899327, 0.001047000, 0.000000000 },
    { 0.002049190, 0.000740000, 0.000000000 },
    { 0.001439971, 0.000520000, 0.000000000 },
    { 0.000999949, 0.000361100, 0.000000000 },
    { 0.000690079, 0.000249200, 0.000000000 },
    { 0.000476021, 0.000171900, 0.000000000 },
    { 0.000332301, 0.000120000, 0.000000000 },
    { 0.000234826, 0.000084800, 0.000000000 },
    { 0.000166151, 0.000060000, 0.000000000 },
    { 0.000117413, 0.000042400, 0.000000000 },
    { 0.000083100, 0.000030000, 0.000000000 },
    { 0.000058700, 0.000021200, 0.000000000 },
    { 0.000041500, 0.000015000, 0.000000000 }
};

// clang-format on

void check_dimensions( const rta::core::SpectralData &data, size_t c )
{
    const auto &d = data.data;
    OIIO_CHECK_EQUAL( d.size(), 1 );

    const auto &m = d.at( "main" );
    OIIO_CHECK_EQUAL( m.size(), c );

    for ( size_t i = 0; i < c; i++ )
    {
        const auto &s = m[i];
        OIIO_CHECK_EQUAL( s.shape.first, 380.0 );
        OIIO_CHECK_EQUAL( s.shape.last, 780.0 );
        OIIO_CHECK_EQUAL( s.shape.step, 5.0 );
        OIIO_CHECK_EQUAL( s.values.size(), 81 );
    }
}

// Check if the camera contains the Nikon D200 sensitivity data.
void check_camera( const rta::core::SpectralData &camera )
{
    check_dimensions( camera, 3 );

    for ( size_t i = 0; i < 3; i++ )
    {
        const auto &s = camera.data.at( "main" )[i];
        for ( size_t j = 0; j < 81; j++ )
            OIIO_CHECK_EQUAL_THRESH(
                s.values[j], nikon_d200_sensitivity[j][i], 1e-30 );
    }
}

// Check if the illuminant contains the ISO7589 studio tungsten light spectrum.
void check_illuminant( const rta::core::SpectralData &illuminant )
{
    check_dimensions( illuminant, 1 );

    const auto &s = illuminant.data.at( "main" )[0];

    for ( size_t j = 0; j < 81; j++ )
        OIIO_CHECK_EQUAL_THRESH(
            s.values[j], illuminant_ISO7589_SPD[j], 1e-30 );
}

// Check if the cmf object contains the CIE-1931 XYZ colour matching functions.
// The data file contains 360:830:1 samples, so the code also checks
// if resampling to 380:780:5 works correctly.
void check_cmf( const rta::core::SpectralData &cmf )
{
    check_dimensions( cmf, 3 );

    for ( size_t i = 0; i < 3; i++ )
    {
        const auto &s = cmf.data.at( "main" )[i];
        for ( size_t j = 0; j < 81; j++ )
            OIIO_CHECK_EQUAL_THRESH(
                s.values[j], colour_matching_XYZ[j][i], 1e-30 );
    }
}

// Check if the illuminant contains the ISO7589 studio tungsten light spectrum
// scaled to the Nikon D200 curves.
void check_scale_illuminant( const rta::core::SpectralData &illuminant )
{
    check_dimensions( illuminant, 1 );

    double sum = 0;
    for ( size_t i = 0; i < 81; i++ )
    {
        sum += nikon_d200_sensitivity[i][1] * illuminant_ISO7589_SPD[i];
    }

    double scale = 1 / sum;
    OIIO_CHECK_EQUAL_THRESH( scale, 0.13655488147514236, 1e-30 );

    const auto &si = illuminant.data.at( "main" )[0];
    for ( size_t i = 0; i < 81; i++ )
        OIIO_CHECK_EQUAL_THRESH(
            si.values[i], illuminant_ISO7589_SPD[i] * scale, 1e-16 );
}

void test_CAT()
{
    // clang-format off
    const double src_wb[3] = {
        1.06789561546674380,
        1.00000000000000000,
        0.41004691570276436
    };
    
    const double dst_wb[3] = {
        0.95264607456984595,
        1.00000000000000000,
        1.00882518435159010
    };
    
    const double cat[3][3] = {
        {  0.8908949453633443500, -0.113493669233048970, 0.27986294595392236},
        { -0.0822708087452159040,  1.042220088327919800, 0.11129591728250078},
        {  0.0057446406440006493,  0.019137946949782242, 2.39863421277044120}
    };
    // clang-format on

    std::vector<double> src( src_wb, src_wb + 3 );
    std::vector<double> dst( XYZ_w, XYZ_w + 3 );

    rta::core::SpectralSolver solver;
    auto                      result = solver.calculate_CAT( src, dst );

    OIIO_CHECK_EQUAL( result.size(), 3 );
    OIIO_CHECK_EQUAL( result[0].size(), 3 );

    for ( size_t i = 0; i < 3; i++ )
        for ( size_t j = 0; j < 3; j++ )
            OIIO_CHECK_EQUAL_THRESH( result[i][j], cat[i][j], 1e-6 );
}

void test_solver()
{
    rta::core::SpectralData camera(
        data_path + "camera/nikon_d200_380_780_5.json" );
    check_camera( camera );

    rta::core::SpectralData illuminant(
        data_path + "illuminant/iso7589_stutung_380_780_5.json" );
    check_illuminant( illuminant );

    rta::core::SpectralSolver solver;
    solver.current_camera = camera;
    solver.scale_illuminant( illuminant );
    check_scale_illuminant( illuminant );

    auto wb =
        solver.calculate_white_balance( illuminant, solver.current_camera );
    OIIO_CHECK_EQUAL_THRESH( wb[0], 1.1397265403538983, 1e-30 );
    OIIO_CHECK_EQUAL( wb[1], 1 );
    OIIO_CHECK_EQUAL_THRESH( wb[2], 2.3240151642033657, 1e-30 );

    rta::core::SpectralData cmf( data_path + "cmf/cmf_1931.json", true );
    check_cmf( cmf );

    solver.current_illuminant = illuminant;
    solver.white_balance      = wb;
    solver.colour_matching    = cmf;

    solver.prepare_training_data(
        data_path + "training/training_spectral.json" );

    auto XYZ = solver.calculate_training_XYZ();
    auto RGB = solver.calculate_training_RGB();
}

int main( int, char ** )
{
    test_CAT();
    test_solver();
    return unit_test_failures;
}
